---
title: 'Análisis de redes: Game of Thrones'
author: 
 - Oscar Arturo  
 - Karina Lizette   
 - Víctor Erasto 97105
date: "17/5/2021"
output:
  prettydoc::html_pretty:
    theme: architect
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=F, message=F, warning=F}
library(tidyverse)
library(tidygraph)
library(ggraph)
library(magrittr)
library(visNetwork)
```


## Objetivo general
Identificar la importancia de los personajes en la saga de libros *A Song of Ice and Fire* escrita por George R. R. Martin por medio de un análisis de redes.

### Objetivos particulares
- Conocer a los personajes que tiene mayor importancia de acuerdo a las medidas de centralidad
- Ver el cambio de importancia de personajes entre los libros de la saga
- Identificar si la importancia de los personajes cambia dependiendo de las medidas de centralidad
- 


## Metodología

Para conocer la importancia de los personajes, realizaremos un análisis no dirigido, usando las siguientes medidas de centralidad:

#### Grado o grado de entrada/salida 

Definición: cuántas ligas tiene un nodo (no dirigidos).   

El grado del nodo i se calcula como:   
$$c_G(i)=\sum_{j\neq i} A_{i,j}.$$
donde $G$ es una gráfica **no dirigida**, y sea $A$ la matriz de adyacencia de $G$.


#### Betweeness 

Definición: qué tan importante o único es un nodo para conectar otros pares de nodos de la red.   

En este caso particular, es una medida importante porque personajes con valores altos pueden ser negociadores entre otros personajes o pueden controlar el flujo de información (importante para ganar guerras).   

Esta medida se calcula como:   
$$c_b (u) = \sum_{j<k, u\neq j,u\neq i} \frac{ g(j,k |u)}{ g(j,k)},$$
donde

- $g(j,k)$ es el número de caminos más cortos distintos entre $j$ y $k$ y 
- $g(j,k |u)$ es el número de caminos más cortos distintos entre $j$ y $k$ que pasan por $u$. 
- $g(j,k | u ) = 0$ cuando $j=u$ o $k=u$.  

#### Cercanía

Definición: qué tan lejos en promedio están los otros nodos de la red. 

Ésta medida se calcula como el inverso del promedio de distancias del nodo a todos los demás.

$$C (x) = \frac{1}{\sum_{y} d(x, y)}$$
donde $$d(y, x)$$ es la distancia entre los nodos x y y   

#### Centralidad de eigenvector/Pagerank

Definición: la centralidad de un nodo es una especie de promedio de la centralidad de sus vecinos. Esta medida considera que la importancia de un nodo está dado por la suma normalizada de las importancias de sus vecinos. De esta forma, es importante estar cercano a nodos importantes (como en cercanía), pero también cuenta conectarse a muchos nodos (como en grado).


## Base de datos

Fuente: [Kaggle](https://www.kaggle.com/mmmarchetti/game-of-thrones-network-analysis)

La base de datos tiene 4 variables:  
- Source: un nodo en la red    
- Target: un nodo en la red     
- Weight: número de interacciones que los personajes tienen   
- Book: el libro al que pertenece la interacción     

```{r, echo=F, message=F, warning=F}

book1 <- read_csv("data/book1.csv")
book2 <- read_csv("data/book2.csv")
book3 <- read_csv("data/book3.csv")
book4 <- read_csv("data/book4.csv")
book5 <- read_csv("data/book5.csv")

data <- rbind(book1, book2, book3, book4, book5)

data <- data %>% 
  rename(from = Source, to = Target) %>% 
  select(-Type) 


data %>% head()
```

## A Game of Thrones (1996)

#### Centralidad

```{r, echo=F, message=F, warning=F}
season = 1
data_ss = data %>% filter(book == season)

edges <- data_ss %>% as_tibble()

# CENTRALIDAD

{  
  nodes_centrality <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_degree(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)


  nw_ss_centrality <- visNetwork(nodes_centrality, edges, height = "600px", width = "100%",
             main = paste("Analytics Methods: Game Of Thrones", season, "Network: Centralidad")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'pupple', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_centrality

  }
```

En la siguiente tabla se pueden ver los 10 personajes con mayor valor de centralidad:   

```{r, echo=F, message=F, warning=F}
top_ss_centralidad <- nodes_centrality %>%   
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id,
         Centralidad = value)

top_ss_centralidad %>% 
  ggplot(aes(y = reorder(Personaje, Centralidad), x = Centralidad)) + 
  geom_col() + ylab("Personaje")

```

#### Betweeness o intermediación

```{r, echo=F, message=F, warning=F}
# BETWEENEESS
{
  nodes_btw <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_betweenness(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_btw <- visNetwork(nodes_btw, edges, height = "600px", width = "100%",
                                 main = paste("Analytics Methods: Game Of Thrones", season, "Network: Betweenness")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightblue', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')

#nw_ss_btw
}
```


En la siguiente tabla se pueden ver los 10 personajes con mayor valor de intermediación:   

```{r, echo=F, message=F, warning=F}
top_ss_btw <- nodes_btw %>%
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Intermediación = value, 
         Personaje = id)

top_ss_btw %>% 
  ggplot(aes(y = reorder(Personaje, Intermediación), x = Intermediación)) + 
  geom_col() + ylab("Personaje")
```

#### Cercanía

```{r, echo=F, message=F, warning=F}
# CERCANIA

{  
  
  nodes_cls <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_closeness(normalized = TRUE),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_cls <- visNetwork(nodes_cls, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Cercania")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightgreen', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_cls
  
}  
```

A continuación se pueden ver los 10 personajes con mayor valor de cercanía:   
```{r, echo=F, message=F, warning=F}
top_ss_cls<- nodes_cls %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select (id, value) %>% 
  rename(Personaje = id,
         Cercanía = value)

top_ss_cls%>% 
  ggplot(aes(y = reorder(Personaje, Cercanía), x = Cercanía)) + 
  geom_col() + ylab("Personaje")
```

#### Eigen
```{r, echo=F, message=F, warning=F}
{  
  
  nodes_eigen <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_eigen(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_eigen <- visNetwork(nodes_eigen, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Eigen")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'wheat', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_eigen
 
}  
```

A continuación se pueden ver los 10 personajes con mayor valor eigen:    
```{r, echo=F, message=F, warning=F}
 
top_ss_eigen <- nodes_eigen %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id,
         Eigen = value)

top_ss_eigen %>% 
  ggplot(aes(y = reorder(Personaje, Eigen), x = Eigen)) + 
  geom_col() + ylab("Personaje")
  
```


## A Clash of Kings (1998)

#### Centralidad

```{r, echo=F, message=F, warning=F}
season = 2
data_ss = data %>% filter(book == season)

edges <- data_ss %>% as_tibble()

# CENTRALIDAD

{  
  nodes_centrality <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_degree(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)


  nw_ss_centrality <- visNetwork(nodes_centrality, edges, height = "600px", width = "100%",
             main = paste("Analytics Methods: Game Of Thrones", season, "Network: Centralidad")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'pupple', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_centrality

  }
```

En la siguiente tabla se pueden ver los 10 personajes con mayor valor de centralidad:   

```{r, echo=F, message=F, warning=F}
top_ss_centralidad <- nodes_centrality %>%   
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id,
         Centralidad = value)

top_ss_centralidad %>% 
  ggplot(aes(y = reorder(Personaje, Centralidad), x = Centralidad)) + 
  geom_col() + ylab("Personaje")
```

#### Betweeness o intermediación

```{r, echo=F, message=F, warning=F} 

# BETWEENEESS
{
  nodes_btw <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_betweenness(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_btw <- visNetwork(nodes_btw, edges, height = "600px", width = "100%",
                                 main = paste("Analytics Methods: Game Of Thrones", season, "Network: Betweenness")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightblue', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')

#nw_ss_btw
}
```


En la siguiente tabla se pueden ver los 10 personajes con mayor valor de intermediación:   

```{r, echo=F, message=F, warning=F}
top_ss_btw <- nodes_btw %>%
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Intermediación = value, 
         Personaje = id)

top_ss_btw %>% 
  ggplot(aes(y = reorder(Personaje, Intermediación), x = Intermediación)) + 
  geom_col() + ylab("Personaje")
```

#### Cercanía

```{r, echo=F, message=F, warning=F}
# CERCANIA

{  
  
  nodes_cls <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_closeness(normalized = TRUE),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_cls <- visNetwork(nodes_cls, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Cercania")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightgreen', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_cls
  
}  
```

A continuación se pueden ver los 10 personajes con mayor valor de cercanía:   
```{r, echo=F, message=F, warning=F}
top_ss_cls<- nodes_cls %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select (id, value) %>% 
  rename(Personaje = id,
         Cercanía = value)

top_ss_cls %>% 
  ggplot(aes(y = reorder(Personaje, Cercanía), x = Cercanía)) + 
  geom_col() + ylab("Personaje")
```

#### Eigen
```{r, echo=F, message=F, warning=F}
{  
  
  nodes_eigen <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_eigen(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_eigen <- visNetwork(nodes_eigen, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Eigen")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'wheat', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_eigen
 
}  
```

A continuación se pueden ver los 10 personajes con mayor valor eigen:    
```{r, echo=F, message=F, warning=F}
 
top_ss_eigen <- nodes_eigen %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id, 
         Eigen = value)

top_ss_eigen %>% 
  ggplot(aes(y = reorder(Personaje, Eigen), x = Eigen)) + 
  geom_col() + ylab("Personaje")
  
```


## A Storm of Swords (2000)

#### Centralidad

```{r, echo=F, message=F, warning=F}
season = 3
data_ss = data %>% filter(book == season)

edges <- data_ss %>% as_tibble()

# CENTRALIDAD

{  
  nodes_centrality <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_degree(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)


  nw_ss_centrality <- visNetwork(nodes_centrality, edges, height = "600px", width = "100%",
             main = paste("Analytics Methods: Game Of Thrones", season, "Network: Centralidad")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'pupple', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_centrality

  }
```

En la siguiente tabla se pueden ver los 10 personajes con mayor valor de centralidad:   

```{r, echo=F, message=F, warning=F}
top_ss_centralidad <- nodes_centrality %>%   
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id, 
         Centralidad = value)

top_ss_centralidad %>% 
  ggplot(aes(y = reorder(Personaje, Centralidad), x = Centralidad)) + 
  geom_col() + ylab("Personaje")

```

#### Betweeness o intermediación

```{r, echo=F, message=F, warning=F}
# BETWEENEESS
{
  nodes_btw <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_betweenness(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_btw <- visNetwork(nodes_btw, edges, height = "600px", width = "100%",
                                 main = paste("Analytics Methods: Game Of Thrones", season, "Network: Betweenness")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightblue', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')

#nw_ss_btw
}
```


En la siguiente tabla se pueden ver los 10 personajes con mayor valor de intermediación:   

```{r}
top_ss_btw <- nodes_btw %>%
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Intermediación = value, 
         Personaje = id)

top_ss_btw %>% 
  ggplot(aes(y = reorder(Personaje, Intermediación), x = Intermediación)) + 
  geom_col() + ylab("Personaje")
```

#### Cercanía

```{r, echo=F, message=F, warning=F}
# CERCANIA

{  
  
  nodes_cls <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_closeness(normalized = TRUE),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_cls <- visNetwork(nodes_cls, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Cercania")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightgreen', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_cls
  
}  
```

A continuación se pueden ver los 10 personajes con mayor valor de cercanía:   
```{r, echo=F, message=F, warning=F}
top_ss_cls<- nodes_cls %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select (id, value) %>% 
  rename(Personaje = id,
         Cercanía = value)

top_ss_cls %>% 
  ggplot(aes(y = reorder(Personaje, Cercanía), x = Cercanía)) + 
  geom_col() + ylab("Personaje")
```

#### Eigen
```{r, echo=F, message=F, warning=F}
{  
  
  nodes_eigen <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_eigen(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_eigen <- visNetwork(nodes_eigen, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Eigen")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'wheat', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_eigen
 
}  
```

A continuación se pueden ver los 10 personajes con mayor valor eigen:    
```{r, echo=F, message=F, warning=F}
 
top_ss_eigen <- nodes_eigen %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id, 
         Eigen = value)

top_ss_eigen %>% 
  ggplot(aes(y = reorder(Personaje, Eigen), x = Eigen)) + 
  geom_col() + ylab("Personaje")
  
```

## A Feast for Crows (2005)

#### Centralidad

```{r, echo=F, message=F, warning=F}
season = 4
data_ss = data %>% filter(book == season)

edges <- data_ss %>% as_tibble()

# CENTRALIDAD

{  
  nodes_centrality <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_degree(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)


  nw_ss_centrality <- visNetwork(nodes_centrality, edges, height = "600px", width = "100%",
             main = paste("Analytics Methods: Game Of Thrones", season, "Network: Centralidad")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'pupple', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_centrality

  }
```

En la siguiente tabla se pueden ver los 10 personajes con mayor valor de centralidad:   

```{r, echo=F, message=F, warning=F}
top_ss_centralidad <- nodes_centrality %>%   
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id, 
         Centralidad = value)

top_ss_centralidad %>% 
  ggplot(aes(y = reorder(Personaje, Centralidad), x = Centralidad)) + 
  geom_col() + ylab("Personaje")
```

#### Betweeness o intermediación

```{r, echo=F, message=F, warning=F}
# BETWEENEESS
{
  nodes_btw <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_betweenness(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_btw <- visNetwork(nodes_btw, edges, height = "600px", width = "100%",
                                 main = paste("Analytics Methods: Game Of Thrones", season, "Network: Betweenness")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightblue', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')

#nw_ss_btw
}
```


En la siguiente tabla se pueden ver los 10 personajes con mayor valor de intermediación:   

```{r, echo=F, message=F, warning=F}
top_ss_btw <- nodes_btw %>%
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Intermediación = value, 
         Personaje = id)

top_ss_btw %>% 
  ggplot(aes(y = reorder(Personaje, Intermediación), x = Intermediación)) + 
  geom_col() + ylab("Personaje")
```

#### Cercanía

```{r, echo=F, message=F, warning=F}
# CERCANIA

{  
  
  nodes_cls <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_closeness(normalized = TRUE),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_cls <- visNetwork(nodes_cls, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Cercania")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightgreen', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_cls
  
}  
```

A continuación se pueden ver los 10 personajes con mayor valor de cercanía:   
```{r, echo=F, message=F, warning=F}
top_ss_cls<- nodes_cls %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select (id, value) %>% 
  rename(Personaje = id,
         Cercanía = value)

top_ss_cls %>% 
  ggplot(aes(y = reorder(Personaje, Cercanía), x = Cercanía)) + 
  geom_col() + ylab("Personaje")
```

#### Eigen
```{r, echo=F, message=F, warning=F}
{  
  
  nodes_eigen <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_eigen(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_eigen <- visNetwork(nodes_eigen, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Eigen")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'wheat', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_eigen
 
}  
```

A continuación se pueden ver los 10 personajes con mayor valor eigen:    
```{r, echo=F, message=F, warning=F}
 
top_ss_eigen <- nodes_eigen %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id, 
         Eigen = value)

top_ss_eigen %>% 
  ggplot(aes(y = reorder(Personaje, Eigen), x = Eigen)) + 
  geom_col() + ylab("Personaje")
  
```

## A Dance with Dragons (2011)

#### Centralidad

```{r, echo=F, message=F, warning=F}
season = 5
data_ss = data %>% filter(book == season)

edges <- data_ss %>% as_tibble()

# CENTRALIDAD

{  
  nodes_centrality <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_degree(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)


  nw_ss_centrality <- visNetwork(nodes_centrality, edges, height = "600px", width = "100%",
             main = paste("Analytics Methods: Game Of Thrones", season, "Network: Centralidad")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'pupple', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_centrality

  }
```

En la siguiente tabla se pueden ver los 10 personajes con mayor valor de centralidad:   

```{r, echo=F, message=F, warning=F}
top_ss_centralidad <- nodes_centrality %>%   
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id, 
         Centralidad = value)

top_ss_centralidad %>% 
  ggplot(aes(y = reorder(Personaje, Centralidad), x = Centralidad)) + 
  geom_col() + ylab("Personaje")
```

#### Betweeness o intermediación

```{r, echo=F, message=F, warning=F}
# BETWEENEESS
{
  nodes_btw <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_betweenness(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_btw <- visNetwork(nodes_btw, edges, height = "600px", width = "100%",
                                 main = paste("Analytics Methods: Game Of Thrones", season, "Network: Betweenness")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightblue', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')

#nw_ss_btw
}
```


En la siguiente tabla se pueden ver los 10 personajes con mayor valor de intermediación:   

```{r, echo=F, message=F, warning=F}
top_ss_btw <- nodes_btw %>%
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Intermediación = value, 
         Personaje = id)

top_ss_btw %>% 
  ggplot(aes(y = reorder(Personaje, Intermediación), x = Intermediación)) + 
  geom_col() + ylab("Personaje")
```

#### Cercanía

```{r, echo=F, message=F, warning=F}
# CERCANIA

{  
  
  nodes_cls <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_closeness(normalized = TRUE),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_cls <- visNetwork(nodes_cls, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Cercania")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightgreen', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_cls
  
}  
```

A continuación se pueden ver los 10 personajes con mayor valor de cercanía:   
```{r, echo=F, message=F, warning=F}
top_ss_cls<- nodes_cls %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select (id, value) %>% 
  rename(Personaje = id,
         Cercanía = value)

top_ss_cls %>% 
  ggplot(aes(y = reorder(Personaje, Cercanía), x = Cercanía)) + 
  geom_col() + ylab("Personaje")
```

#### Eigen
```{r, echo=F, message=F, warning=F}
{  
  
  nodes_eigen <- tidygraph::as_tbl_graph(data_ss, directed = FALSE) %>% 
    mutate(value = centrality_eigen(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_ss_eigen <- visNetwork(nodes_eigen, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", season, "Network: Eigen")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'wheat', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_ss_eigen
 
}  
```

A continuación se pueden ver los 10 personajes con mayor valor eigen:    
```{r, echo=F, message=F, warning=F}
 
top_ss_eigen <- nodes_eigen %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id, 
         Eigen = value)

top_ss_eigen %>% 
  ggplot(aes(y = reorder(Personaje, Eigen), x = Eigen)) + 
  geom_col() + ylab("Personaje")
  
```


## Análisis conjunto de la saga completa

#### Centralidad
```{r, echo=F, message=F, warning=F}
edges <- data %>% as_tibble()

{  
  nodes_centrality <- tidygraph::as_tbl_graph(data, directed = FALSE) %>% 
    mutate(value = centrality_degree(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_centrality <- visNetwork(nodes_centrality, edges, height = "600px", width = "100%",
                                 main = paste("Analytics Methods: Game Of Thrones", "", "Network: Centralidad")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightpink', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_centrality
  
  
}
```

```{r, echo=F, message=F, warning=F}
top_centralidad <- nodes_centrality %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id, 
         Centralidad = value)

top_centralidad %>% 
  ggplot(aes(y = reorder(Personaje, Centralidad), x = Centralidad)) + 
  geom_col() + ylab("Personaje")
  
```

#### Intermediación

```{r, echo=F, message=F, warning=F}
{
  nodes_btw <- tidygraph::as_tbl_graph(data, directed = FALSE) %>% 
    mutate(value = centrality_betweenness(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_btw <- visNetwork(nodes_btw, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", "", "Network: Betweenness")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightblue', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_btw

}

```

```{r, echo=F, message=F, warning=F}
  
  top_btw <- nodes_btw %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Intermediación = value, 
         Personaje = id)

top_btw %>% 
  ggplot(aes(y = reorder(Personaje, Intermediación), x = Intermediación)) + 
  geom_col() + ylab("Personaje")


  
```

#### Cercanía
```{r, echo=F, message=F, warning=F}
{  
  
  nodes_cls <- tidygraph::as_tbl_graph(data, directed = FALSE) %>% 
    mutate(value = centrality_closeness(normalized = TRUE),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_cls <- visNetwork(nodes_cls, edges, height = "600px", width = "100%",
                          main = paste("Analytics Methods: Game Of Thrones", "", "Network: Cercania")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'lightgreen', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_cls
  

}  

```

```{r, echo=F, message=F, warning=F}
top_cls<- nodes_cls %>% 
  arrange(desc(value)) %>% 
  head(10) %>% 
  select (id, value) %>% 
  rename(Personaje = id,
         Cercanía = value)

top_cls %>% 
  ggplot(aes(y = reorder(Personaje, Cercanía), x = Cercanía)) + 
  geom_col() + ylab("Personaje")


```

#### Eigen

```{r, echo=F, message=F, warning=F}
{  
  
  nodes_eigen <- tidygraph::as_tbl_graph(data, directed = FALSE) %>% 
    mutate(value = centrality_eigen(),
           id = name,
           title = name,
    ) %>% 
    as_tibble() %>% 
    rename(label = name) %>% 
    select(id, label, title, value)
  
  
  nw_eigen <- visNetwork(nodes_eigen, edges, height = "600px", width = "100%",
                            main = paste("Analytics Methods: Game Of Thrones", "", "Network: Eigen")) %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(color = 'wheat', value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  
  #nw_eigen
  
 
  
}  
```

```{r, echo=F, message=F, warning=F}
top_eigen <- nodes_eigen %>%  
  arrange(desc(value)) %>% 
  head(10) %>% 
  select(id, value) %>% 
  rename(Personaje = id, 
         Eigen = value)

top_eigen %>% 
  ggplot(aes(y = reorder(Personaje, Eigen), x = Eigen)) + 
  geom_col() + ylab("Personaje")


```



A continuación podemos ver un gráfico donde se analiza la centralidad y la intermediación de los personajes   

```{r, echo=F, message=F, warning=F}
nodes <- tidygraph::as_tbl_graph(data, directed = FALSE) %>% 
  mutate(value = centrality_degree(),
         value_btw = centrality_betweenness(directed = F),
         value_cls = centrality_closeness(normalized = TRUE) ,
         value_eigen = centrality_eigen(directed = F),
         id = name,
         title = name,
  ) %>% 
  as_tibble() %>% 
  rename(label = name) %>% 
  select(id, label, title, value, value_btw, value_cls, value_eigen)


  cols <- colorRampPalette(c("red", "blue"))
  colores <- cols(length(nodes$value_btw))
  nodes %<>% mutate(color = colores[rank(value_btw)])

  nw_centralidad_btw <- visNetwork(nodes, edges, height = "600px", width = "100%",
           main = "Analytics Methods: Game Of Thrones Network \n
           Centralidad y Betweenness") %>% 
  #visInteraction(navigationButtons = TRUE) %>%
  visPhysics(
    solver = 'forceAtlas2Based', 
    stabilization = T,
    forceAtlas2Based = list(
      gravitationalConstant = -20, 
      centralGravity = 0.01, 
      springLength = 100,
      springConstant = 0.08,
      avoidOverlap = 0
    )
  ) %>% 
  visNodes(value = 1, scaling = list(min = 10, max = 60)) %>% 
  visEdges(color = "darkgray") %>% 
  visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
  visLegend(main = 'value')

  #nw_centralidad_btw
```

A continuación podemos ver un gráfico donde se analiza la centralidad y el valor eigen de los personajes   

```{r, echo=F, message=F, warning=F}

  cols <- colorRampPalette(c("pink", "blue"))
  colores <- cols(length(nodes$value_eigen))
  nodes %<>% mutate(color = colores[rank(value_eigen)])
  
  
  nw_centralidad_eigen <- visNetwork(nodes, edges, height = "600px", width = "100%",
             main = "Analytics Methods: Game Of Thrones Network \n
             Centralidad y Eigen") %>% 
    #visInteraction(navigationButtons = TRUE) %>%
    visPhysics(
      solver = 'forceAtlas2Based', 
      stabilization = T,
      forceAtlas2Based = list(
        gravitationalConstant = -20, 
        centralGravity = 0.01, 
        springLength = 100,
        springConstant = 0.08,
        avoidOverlap = 0
      )
    ) %>% 
    visNodes(value = 1, scaling = list(min = 10, max = 60)) %>% 
    visEdges(color = "darkgray") %>% 
    visOptions(highlightNearest = TRUE, nodesIdSelection = T) %>% 
    visLegend(main = 'value')
  

  #nw_centralidad_eigen

```

